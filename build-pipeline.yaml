pool:


steps:
# Building and pushing images to image repository
- task: Docker@2
  inputs:
    containerRegistry: 'docker-jfrog-artifactory'
    repository: 'default-docker-remote/'
    command: 'buildAndPush'
    dockerfile: '**/Dockerfile'

- task: Docker@0
  displayName: 'Build a container image'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryConnection: 'docker-jfrog-artifactory'

- task: Docker@0
  displayName: 'Push a container image'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryConnection: 'docker-jfrog-artifactory'
    action: 'Push an image'

# Pulling images and packaging Helm Chart(s)
- task: HelmInstaller@0 # Installs 2.9.1, but v3 pretty different. Change it
  displayName: 'Install Helm 2.9.1'
  inputs:
    helmVersion: 2.9.1
    kubectlVersion: 1.10.3
    checkLatestKubectl: false

- task: HelmDeploy@0  # helm init removed from v3, remember it
  displayName: 'helm init --client-only'
  inputs:
    azureSubscription: 'Azure for Students (2036e40b-3de5-45c0-b683-a77c62b17380)'
    azureResourceGroup: rg
    kubernetesCluster: aks
    command: init
    upgradeTiller: false
    arguments: '--client-only'

- task: HelmDeploy@0
  displayName: 'helm package'
  inputs:
    command: package
    chartPath: .  # Not a folder, put it just to make GUI happy
    save: false

# Publishing artifacts
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifacts: drop'
