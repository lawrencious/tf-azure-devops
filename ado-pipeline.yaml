variables:
  ${{ if eq( variables['Build.BuildId'], 0 ) }}:
    command: 'apply'
    arguments: '-f path/to/manifests'
  ${{ else }}:
    command: 'set'  # 'rollout' is not yet available as a kubectl command option 
    arguments: 'image [TYPES] hello=hello:$(Build.BuildId) --all'
  imgBaseName: '$(artifactoryURL)/artifactory'
  usingJF: 'false'
  separetedBuildPush: 'true'

trigger:
- main

pool: 
  vmImage: ubuntu-latest

stages:
  - stage: Configuration
    jobs:
    - job: Configuration
      displayName: Installing Docker, kubectl, JFrog CLI
      steps:
      - task: DockerInstaller@0
        displayName: Installing Docker
        inputs:
          dockerVersion: '18.09.4'
          
      - task: KubectlInstaller@0
        displayName: Installing kubectl 
        inputs:
          kubectlVersion: 'latest'

      - task: ArtifactoryToolsInstaller@1
        condition: eq(variables.usingJF, 'true')
        inputs:
          artifactoryService: 'tf-ado-artifactory-cli-conn'
          cliInstallationRepo: 'cli'
        
  - stage: Build
    displayName: 'Building and pushing images'
    jobs:
      - job: Build
        steps:
        - task: Docker@2
          displayName: 'Logging to JFA (Docker task)'
          inputs:
            containerRegistry: 'tf-ado-artifactory-repo-connection'
            command: 'login'
        - script: |
            docker login $(ARTIFACTORYURL) -u $(ARTIFACTORY_USER) -p $(ARTIFACTORY_ACCESS_TOKEN)
          displayName: 'Logging to JFA (script)'
        
        - task: Docker@2
          condition: eq(variables.separetedBuildPush, 'true')
          displayName: 'Building image'
          inputs:
            containerRegistry: 'tf-ado-artifactory-repo-connection'
            repository: 'artifactory/tf-ado-docker-local'
            command: 'build'
            Dockerfile: '**/Dockerfile'
        
        - script: |
            docker image ls
          condition: eq(variables.separetedBuildPush, 'true')
          displayName: 'Listing local images'
        
        - task: Docker@2
          condition: and(ne(variables.usingJF, 'true'), ne(variables.separetedBuildPush, 'true'))
          displayName: 'Building and pushing image'
          inputs:
            containerRegistry: 'tf-ado-artifactory-repo-connection'
            repository: 'artifactory/tf-ado-docker-local'
            command: 'buildAndPush'
            Dockerfile: '**/Dockerfile'

        - task: Docker@2
          condition: and(ne(variables.usingJF, 'true'), eq(variables.separetedBuildPush, 'true'))
          displayName: 'Pushing image (Docker)'
          inputs:
            containerRegistry: 'tf-ado-artifactory-repo-connection'
            repository: 'artifactory/tf-ado-docker-local'
            command: 'push'
            Dockerfile: '**/Dockerfile'

        - task: ArtifactoryDocker@1
          displayName: 'Pushing image (JFA)'
          condition: eq(variables.usingJF, 'true')
          inputs:
            command: 'push'
            artifactoryService: 'tf-ado-artifactory-cli-conn'
            targetRepo: 'tf-ado-cicd-repo'
            imageName: '$(imgBaseName)/tf-ado-docker-local:$(Build.BuildId)'

  - stage: Deploy
    dependsOn: Build
    displayName: 'Updating cluster resources'
    jobs:
    - job: Deploy
      steps:
      # Deploys containers
      - task: Kubernetes@1
        inputs:
          connectionType: 'Kubernetes Service Connection'
          kubernetesServiceEndpoint: 'tf-ado-aks-connection'
          command: '$(command)'
          arguments: '$(arguments)'
          secretType: 'dockerRegistry'
          containerRegistryType: 'Container Registry'
          dockerRegistryEndpoint: 'tf-ado-artifactory-repo-connection'
